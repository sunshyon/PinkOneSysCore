<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <link rel="shortcut icon" type="image/x-icon" href="/Images/pinkone.ico" />

    <title>Pink One 校园管理系统</title>

    <!-- Fab Admin skins -->
    <link href="~/template-bootstrap/css/skins/_all-skins.css" rel="stylesheet" />

    <!-- Bootstrap 4.0-->
    @*<link href="~/template-bootstrap/css/bootstrap.min.css" rel="stylesheet" />*@
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap extend-->
    @*<link href="~/template-bootstrap/css/bootstrap-extend.css" rel="stylesheet" />*@
    <link href="~/template-bootstrap/css/bootstrap-extend.min.css" rel="stylesheet" />
    <!-- Theme style -->
    @*<link href="~/template-bootstrap/css/master_style.css" rel="stylesheet" />*@
    <link href="~/template-bootstrap/css/master_style.min.css" rel="stylesheet" />


    <!-- Sweet-Alert  -->
    @*<link href="~/template-bootstrap/css/sweetalert.css" rel="stylesheet" />*@
    <link href="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.css" rel="stylesheet" />
    <!--datetimepicker-->
    <link href="~/utility/datatimepicker/css/bootstrap-datetimepicker.css" rel="stylesheet" />
    <!--select2-->
    @*<link href="~/template-bootstrap/css/select2.min.css" rel="stylesheet" />*@
    <link href="https://cdn.bootcss.com/select2/4.0.7-rc.0/css/select2.css" rel="stylesheet" />
    <!--datatables-->
    @*<link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet" />*@
    <link href="https://cdn.bootcss.com/datatables/1.10.19/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
    @*<link href="https://cdn.datatables.net/buttons/1.5.6/css/buttons.dataTables.min.css" rel="stylesheet" />*@
    <!-- sunshyon style -->
    <link href="~/utility/utility.css?v=@DateTime.Now" rel="stylesheet" />


    <!-- jQuery 3 -->
    @*<script src="~/template-bootstrap/js/jquery.min.js" charset="utf-8"></script>*@
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <!-- Fab Admin for demo purposes -->
    <script src="~/template-bootstrap/js/demo.js" charset="utf-8"></script>
    <!--popper.js-->
    <script src="~/template-bootstrap/js/popper.min.js"></script>
    <!-- Bootstrap 4.0-->
    @*<script src="~/template-bootstrap/js/bootstrap.min.js" charset="utf-8"></script>*@
    <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- SlimScroll -->
    <script src="~/template-bootstrap/js/jquery.slimscroll.min.js" charset="utf-8"></script>

    <!-- Sweet-Alert  -->
    @*<script src="~/template-bootstrap/js/sweetalert.min.js"></script>*@
    <script src="https://cdn.bootcss.com/sweetalert/1.1.3/sweetalert.min.js"></script>
    <!--datetimepicker-->
    <script src="~/utility/datatimepicker/js/bootstrap-datetimepicker.js"></script>
    <!--select2-->
    @*<script src="~/template-bootstrap/js/select2.min.js"></script>*@
    <script src="https://cdn.bootcss.com/select2/4.0.7-rc.0/js/select2.min.js"></script>
    <!--datatables-->
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js"></script>

    <!--jquery-cookie/-->
    <script src="https://cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <!-- Fab Admin App -->
    <script src="~/template-bootstrap/js/template.js" charset="utf-8"></script>
    <!--Vue-->
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
    <!--signalr-->
    <script src="~/signalr/dist/browser/signalr.js"></script>
    <!--MyJs-->
    <script src="~/utility/utility.js?v=@DateTime.Now.ToString("yyyyMMdd")"></script>

    <style>
        .table thead tr th {
            font-weight: bold;
            padding: 6px !important;
        }

        .table tr td {
            vertical-align: middle !important;
            font-size: 10px !important;
            padding: 5px !important;
        }

        button {
            margin-left: 2px;
        }

        .modal-dialog {
            top: 15%;
        }

        input::-webkit-input-placeholder { /* WebKit, Blink, Edge */
            color: rgba(156, 156, 156, 0.6) !important;
        }

        #refresh {
            display: none;
        }
        
    </style>

    <script>
       
    </script>
</head>

<body class="hold-transition skin-pink sidebar-mini">
    <div class="wrapper">
        <header class="main-header">
            <!-- Logo -->
            <a href="#" class="logo">
                <!-- mini logo -->
                <b class="logo-mini">
                    <img style="margin-top:-4px;" src="~/Images/pinkone_logo.png" />
                    <span>Pink One</span>
                </b>
                <!-- logo-->
                @*<span class="logo-lg">
                    <img src="../../../images/logo-light-text.png" alt="logo" class="light-logo">
                    <img src="../../../images/logo-dark-text.png" alt="logo" class="dark-logo">
                </span>*@
            </a>
            <!-- 头部导航栏 -->
            <nav class="navbar navbar-static-top">
                <!--翻转按钮-->
                <div>
                    <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                        <span class="sr-only">Toggle navigation</span>
                    </a>
                </div>
                <!--刷新动画-->
                <div class="text-center" id="refreshDiv" style="z-index:10;float:right;display:none;">
                    <i class="fa fa-spinner fa-pulse fa-3x fa-fw "></i>
                </div>
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        @*<li class="search-box">
                            <a class="nav-link hidden-sm-down" href="javascript:void(0)"><i class="mdi mdi-magnify"></i></a>
                            <form class="app-search" style="display: none;">
                                <input type="text" class="form-control" placeholder="Search &amp; enter"> <a class="srh-btn"><i class="ti-close"></i></a>
                            </form>
                        </li>*@

                        <!-- chatNotice -->
                        <li class="dropdown notifications-menu hidden-uty" onclick="window.location.href='/TeachingAssistant/Chat'" style="cursor:pointer;">
                            <a >
                                <i id="chatNoticeI" class="fa fa-wechat"></i>
                            </a>
                        </li>

                    </ul>
                </div>
            </nav>
        </header>

        <!-- Left side column. contains the logo and sidebar -->
        <aside class="main-sidebar">
            <!-- sidebar-->
            <section class="sidebar">
                <!-- sidebar menu-->
                <ul class="sidebar-menu" data-widget="tree">
                    <li class="@*user-profile*@ treeview">
                        <a href="index.html">
                            <img id="userAvatar" style="max-height:52px;margin-right:10px;" />
                            <span id="usernameSpan"></span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu">
                            @*<li><a href="javascript:void()"><i class="fa fa-user mr-5"></i>头像 </a></li>*@
                            <li><a href="#" data-toggle="control-sidebar"><i class="icon ion-tshirt-outline mr-5"></i>皮肤</a></li>
                            <li><a href="/Login/Logout"><i class="icon ion-power mr-5"></i>退出</a></li>
                        </ul>
                    </li>
                    <li class="header nav-small-cap">常用功能</li>
                    <li>
                        <a href="~/Home">
                            <i class="fa fa-dashboard"></i> <span>校园概览</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                    </li>
                    <li class="treeview ">
                        <a href="#">
                            <i class="fa fa-book"></i>
                            <span>成长档案</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu">
                            <li id="photoAlbumLi"><a href="/GrowthRelated/Album"><i class="fa fa-circle-thin"></i>相册</a></li>
                            <li id="growthRecordLi"><a href="#"><i class="fa fa-circle-thin"></i>成长记录册</a></li>
                            @*<li id="classManageLi"><a href="#"><i class="fa fa-circle-thin"></i>班级管理</a></li>*@
                        </ul>
                    </li>
                    <li class="treeview ">
                        <a href="#">
                            <i class="fa fa-briefcase"></i>
                            <span>教学助手</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu">
                            <li id="chatRoomLi"><a href="/TeachingAssistant/Chat"><i class="fa fa-circle-thin"></i>聊天室</a></li>
                            <li id="dataShareLi"><a href="#"><i class="fa fa-circle-thin"></i>资料共享</a></li>
                        </ul>
                    </li>
                    <li id="crewLi" class="treeview">
                        <a href="#">
                            <i class="fa fa-users"></i>
                            <span>人员管理</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu">
                            <li id="stuManageLi"><a href="/SchoolRelated/Student"><i class="fa fa-circle-thin"></i>学生管理</a></li>
                            <li id="staffManageLi"><a href="/SchoolRelated/Staff"><i class="fa fa-circle-thin"></i>职员管理</a></li>
                            <li id="classManageLi"><a href="/SchoolRelated/Class"><i class="fa fa-circle-thin"></i>班级管理</a></li>
                        </ul>
                    </li>
                    <li class="treeview">
                        <a href="#">
                            <i class="fa fa-id-card-o"></i> <span>考勤管理</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu">
                            <li class="treeview menu-open">
                                <a href="#">
                                    @*<i class="fa fa-circle-thin"></i>*@学生考勤
                                    <span class="pull-right-container">
                                        <i class="fa fa-angle-right pull-right"></i>
                                    </span>
                                </a>
                                <ul class="treeview-menu" style="display:block;">
                                    <li id="stuAttNowLi"><a href="/AttendanceRelated/StudentAtt/StuAttNow"><i class="fa fa-circle-thin"></i>实时签到</a></li>
                                    <li id="stuAttDetailLi"><a href="/AttendanceRelated/StudentAtt/StuAttDetail"><i class="fa fa-circle-thin"></i>考勤明细</a></li>
                                    <li id="stuAttMouthLi"><a href="/AttendanceRelated/StudentAtt/StuAttMouth"><i class="fa fa-circle-thin"></i>按月统计</a></li>
                                </ul>
                            </li>
                            <li id="staffAttLi" class="treeview menu-open">
                                <a href="#">
                                    @*<i class="fa fa-circle-thin"></i>*@职员考勤
                                    <span class="pull-right-container">
                                        <i class="fa fa-angle-right pull-right"></i>
                                    </span>
                                </a>
                                <ul class="treeview-menu" style="display:block;">
                                    <li id="staffAttNowLi"><a href="/AttendanceRelated/StaffAtt/StaffAttNow"><i class="fa fa-circle-thin"></i>实时签到</a></li>
                                    <li id="staffAttDetailLi"><a href="/AttendanceRelated/StaffAtt/StaffAttDetail"><i class="fa fa-circle-thin"></i>考勤明细</a></li>
                                    <li id="staffAttMouthLi"><a href="/AttendanceRelated/StaffAtt/StaffAttMouth"><i class="fa fa-circle-thin"></i>按月统计</a></li>
                                </ul>
                            </li>
                            <li><a href="#"><i class="fa fa-id-card hidden-uty"></i>卡管理</a></li>
                            <li>
                                <a href="#"><i class="fa fa-wrench hidden-uty"></i>考勤设备</a>
                            </li>
                        </ul>
                    </li>

                    <li id="schoolMngLi">
                        <a href="/SchoolRelated/SchoolManage">
                            <i class="fa fa-gears"></i> <span>校园设置</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-right pull-right"></i>
                            </span>
                        </a>
                    </li>
                </ul>
            </section>
        </aside>
        <div id="contentWrapper" class="content-wrapper">
            <!--各页面主体-->
            @RenderBody()

        </div>
       
        @*<footer class="main-footer">
            <div class="pull-right d-none d-sm-inline-block">
                <ul class="nav nav-primary nav-dotted nav-dot-separated justify-content-center justify-content-md-end">
                    <li class="nav-item">
                        啊手动阀
                    </li>
                    <li class="nav-item">
                    </li>
                </ul>
            </div>
        </footer>*@

        <!-- Control Sidebar -->
        <aside class="control-sidebar control-sidebar-light">
            <!-- Create the tabs -->
            <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
                @*<li class="nav-item"><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
                <li class="nav-item"><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-cog fa-spin"></i></a></li>*@
            </ul>
            <!-- Tab panes -->
            <div class="tab-content">
                <!-- Home tab content -->
                <div class="tab-pane" id="control-sidebar-home-tab">


                </div>

            </div>
        </aside>
        <!-- /.control-sidebar -->
        <!-- Add the sidebar's background. This div must be placed immediately after the control sidebar -->
        <div class="control-sidebar-bg"></div>
    </div>
    <!-- ./wrapper -->

    <script>
        var glbUser;
        var glbNoticeArr;
        var userName = "";
        var avatar = "";
        
        //获取用户信息
        if ($("#usernameSpan").html() == "") {
            $(function () {
                $.ajax({
                    url: "/Home/GetUserInfo",
                    type: "GET",
                    success: function (result) {
                        if (result.code == 1) {
                            var json = JSON.parse(result.content)
                            glbUser = json.user;
                            glbNoticeArr = json.notices;
                            if (json.userType == 1) {//school user
                                $("#chatRoomLi").hide();
                                userName = glbUser.SchoolName;
                                avatar = glbUser.AvatarPic;
                            }
                            else {// staff user
                                userName = glbUser.StaffName;
                                avatar = glbUser.AvatarPic;
                                handleUserMenuPermission();
                                //checkStaffChatMsg();
                                startStaffChatSignalR();
                                $("#chatNoticeI").parent().parent().removeClass("hidden-uty");
                            }

                            $("#usernameSpan").html(userName);
                            if (avatar != null && avatar.length > 10) {
                                $("#userAvatar").attr("src", avatar);
                                glbImgStr = avatar;
                            }
                            if (glbNoticeArr != undefined && glbNoticeArr.length > 0) {
                                $("#noticeDiv").show();
                                $("#noticeDiv").children().children().eq(1).empty();
                                for (var i = 1; i <= glbNoticeArr.length; i++) {
                                    var str = "<p>" + i + "、" + glbNoticeArr.Message + "</p>"
                                    $("#noticeDiv").children().children().eq(1).append(str);
                                }
                            }
                        }
                    },
                    error: function () {
                        swal({ title: "", text: "网络开小差了", type: "warning", timer: 2000, showConfirmButton: false });
                    }
                })
            })
        }
        //处理登录用户主菜单权限
        function handleUserMenuPermission() {
            var roleLevel = glbUser.RoleLevel;
            if (roleLevel >= 3) {//教师级
                $("#staffManageLi").hide();
                $("#classManageLi").hide();
                $("#staffAttLi").hide();
                $("#schoolMngLi").hide();
            }
            if (roleLevel >= 4) {//后勤级

            }
        }

        //管理皮肤
        document.onclick = function (e) {
            if (e.srcElement != undefined && e.srcElement.tagName != undefined && e.srcElement.tagName != "A") {
                $(".control-sidebar").removeClass("control-sidebar-open");
            }
        };

        ///--staffChatHub--///
        function startStaffChatSignalR() {
            //初始化
            var connection = new signalR.HubConnectionBuilder().withUrl("/staffChatHub").build();
            var flag = $("#staffChatPage").val();
            var staffId = glbUser.ID;
            //有新消息
            if (flag == null || flag == undefined || flag == "") {
                var newMsgArrayStr = localStorage.getItem("staffChat" + staffId);
                if (newMsgArrayStr != "[object Object]" && newMsgArrayStr != null) {
                    //提示消息
                    setInterval(function () {
                        $("#chatNoticeI").toggle();
                    }, 700);
                }
            }
            //接受消息
            connection.on("ReceiveMessage", function (chatObj) {
                if (flag == null || flag == undefined || flag == "") {
                    var newMsgArray=new Array();
                    var newMsgArrayStr = localStorage.getItem("staffChat" + staffId);
                    if (newMsgArrayStr != "[object Object]" && newMsgArrayStr!=null ) {
                        newMsgArray = JSON.parse(newMsgArrayStr);
                    }
                    newMsgArray.push(chatObj);
                    localStorage.setItem("staffChat" + staffId, JSON.stringify(newMsgArray))
                    //提示消息
                    setInterval(function () {
                        $("#chatNoticeI").toggle();
                    }, 700);
                    return;
                }
                if (glbUserSelf.userName == chatObj.userName && glbUserSelf.staffId == chatObj.staffId) {
                    return;
                }
                var htmlStr = createChatHtml(1, chatObj);
                $("#chatBoxDiv").append(htmlStr);
                //滚动条到最底部
                var scrollHeight = $('#chatBoxDiv').prop("scrollHeight");
                $('#chatBoxDiv').animate({ scrollTop: scrollHeight }, 500);
                $(".slimScrollBar").css("top", scrollHeight);
            });
            //联系人列表实时变化
            connection.on("chatUserChange", (onlineData) => {
                if (flag == null || flag == undefined||flag=="") {
                    return;
                }
                $(".user-state").removeClass("text-success");
                $(".user-state").html("离线");
                //if (onlineData.schoolIdList.length > 0) {
                //    var ids = onlineData.schoolIdList;
                //    for (var i = 0; i < ids.length; i++) {
                //        $("#schoolState" + ids[i]).addClass("text-success");
                //        $("#schoolState" + ids[i]).html("在线");
                //    }
                //}
                if (onlineData.staffIdList.length > 0) {
                    var ids = onlineData.staffIdList;
                    for (var i = 0; i < ids.length; i++) {
                        $("#staffState" + ids[i]).addClass("text-success");
                        $("#staffState" + ids[i]).html("在线");
                    }
                }
            })
            //启动
            connection.start().then(function () {
            }).catch(function (err) {
                return console.error(err.toString());
            });
            //掉线重连
            connection.onclose(async () => {
                await connection.start();
            })
            //发送消息
            $("#staffChatSendBtn").on("click", function (event) {
                var msg = $("#message").val();
                //msg = msg.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var date = new Date();
                var timeNow = date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + " " + date.getHours() + ":" + date.getMinutes();
                var chatObj = {
                    schoolId: glbUserSelf.schoolId,
                    userName: glbUserSelf.userName,
                    staffId: glbUserSelf.staffId,
                    avatar: glbUserSelf.avatar,
                    targetUserType: 0,
                    targetUserId: 0,
                    time: timeNow,
                    msg: msg
                };
                //渲染自己的消息
                var htmlStr = createChatHtml(2, chatObj);
                $("#chatBoxDiv").append(htmlStr);
                //滚动条到最底部
                var scrollHeight = $('#chatBoxDiv').prop("scrollHeight");
                $('#chatBoxDiv').animate({ scrollTop: scrollHeight }, 500);
                $(".slimScrollBar").css("top", scrollHeight);
                //调用集线器方法
                connection.invoke("SendSchoolMsg", JSON.stringify(chatObj)).catch(function (err) {
                    return console.error(err.toString());
                });
                $("#message").val("");
                event.preventDefault();
            });
        }

        /*
        //----查看该用户是否有新消息---//
        function checkStaffChatMsg() {
            //初始化
            var connection = new signalR.HubConnectionBuilder().withUrl("/staffChatHub").build();
            //启动
            connection.start().then(function () {
            }).catch(function (err) {
                return console.error(err.toString());
            });
            //掉线重连
            connection.onclose(async () => {
                await connection.start();
            })
            //循环查询
            setInterval(function () {
                connection.invoke("CheckUserMsg");
            }, 1000 * 5);
            //发现新消息
            connection.on("haveNewMsg", (msgCount) => {
                alert(msgCount);
            });
        }
        */
    </script>


</body>
</html>
